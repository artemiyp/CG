<HTML>
<BODY>
<canvas id="lab4" width="500" height="500"></canvas>

<script>
    let canvas = document.getElementById("lab4");
    let ctx = canvas.getContext("2d");
    let data;
    let image = new Image();

    let firstS  = [[-1, 0, 1],   [-2, 0, 2], [-1, 0, 1]]
    let secondS = [[-1, -2, -1], [ 0, 0, 0], [ 1, 2, 1]]

    image.src = "D:\\lena.png";
    image.onload = function() {
        ctx.drawImage(image, 0, 0, 500, 500);
        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        data = imageData.data;

        sobel_filter();
    }

    function sobel_filter() {
        let imageDataS = ctx.createImageData(canvas.width, canvas.height);
        let dataS = imageDataS.data;

        for (let i = 3; i < data.length; i+= 4)
            dataS[i] = data[i];

        for (let i = 0; i < 3; i++) {
            for (let j =0; j < canvas.width; j++) {
                for (let k = 0; k < canvas.height; k++) {
                    let matrix = createMatrix(j, k, i, 3)
                    let first = convolution(matrix, firstS);
                    let second = convolution(matrix, secondS);
                    dataS[(k * canvas.width + j) * 4 + i] = Math.sqrt(first * first + second * second)
                }
            }
        }
        ctx.putImageData(imageDataS, 0, 0);
    }

    function createMatrix(x,y,channel,size) {
        let move = (size == 3) ? 1:2;

        let matrix = new Array(size);
        for (let i = 0; i < size; i++) {
            matrix[i] = new Array(size);
            for (let j =0; j < size; j++) {
                let xPix = x-move+i;
                let yPix = y-move+j;
                if (xPix >= 0 && yPix >= 0 && xPix < canvas.width && yPix < canvas.height)
                    matrix[i][j] = data[(yPix*canvas.width+xPix)*4+channel];
                else
                    matrix[i][j] = 0;
            }
            
        }
        return matrix
    }

    function convolution(matrix1, matrix2) {
        let result = 0;
        for (let i =0; i < matrix1.length;i++)
            for (let j =0; j < matrix1.length;j++)
                result += matrix1[i][j]*matrix2[i][j];

    return result
  }

</script>

</body>
</html>